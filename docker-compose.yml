# =============================================================================
# Docker Compose Configuration for TMA Cloud
# =============================================================================
# This file is for running the application using Docker Compose.
# It requires a .env file with all necessary environment variables.
#
# Usage:
#   docker-compose up -d        # Start in background
#   docker-compose logs -f      # View logs
#   docker-compose down          # Stop and remove
#
# Note: Make sure to create a .env file from .env.example before starting.
#
# =============================================================================
# CUSTOM DRIVE MODE (Docker - Per-User Settings)
# =============================================================================
# Custom drive is now configured per-user in the web application settings.
# Users can enable/disable and set their own custom drive path from Settings.
#
# IMPORTANT: All custom drive paths MUST be mounted as volumes in Docker.
# The backend will NOT create directories - they must already exist as mounted volumes.
#
# To mount host directories for users to use as custom drive:
#   Set CUSTOM_DRIVE_MOUNT_1 through CUSTOM_DRIVE_MOUNT_10 in your .env file
#   Format: CUSTOM_DRIVE_MOUNT_N=/host/path:/container/path
#
# Example .env for Linux:
#   CUSTOM_DRIVE_MOUNT_1=/mnt/nas_drive:/data/custom_drive
#   CUSTOM_DRIVE_MOUNT_2=/mnt/data_col:/data_col
#   CUSTOM_DRIVE_MOUNT_3=/mnt/backup:/data/backup
#
# Example .env for Windows (with Docker Desktop):
#   CUSTOM_DRIVE_MOUNT_1=C:/Users/username/my_drive:/data/custom_drive
#   CUSTOM_DRIVE_MOUNT_2=C:/Users/username/data_col:/data_col
#
# Note: Each user can configure their own custom drive path in the Settings page.
# All paths must be mounted volumes - the backend will only validate they exist and are accessible.
# =============================================================================

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    image: tma-cloud:latest
    container_name: tma-cloud-app
    restart: unless-stopped
    ports:
      # Map host port to container port
      # Uses BPORT from .env file, defaults to 3000
      - "${BPORT:-3000}:3000"
    env_file:
      - .env
    environment:
      - LOG_FORMAT=json
    volumes:
      # Mount uploads directory (persists data outside container)
      - ./uploads:/app/uploads
      # Custom drive mounts - configured via environment variables in .env
      # Set CUSTOM_DRIVE_MOUNT_1, CUSTOM_DRIVE_MOUNT_2, etc. in your .env file
      # Format: CUSTOM_DRIVE_MOUNT_N=/host/path:/container/path (REQUIRED - must include colon)
      # Add more mount lines below if you need additional mounts (uncomment and add CUSTOM_DRIVE_MOUNT_3, etc.)
      # Leave empty if not using that mount slot (will use placeholder that won't consume storage)
      # Backend will reject placeholder paths if users try to use them
      - ${CUSTOM_DRIVE_MOUNT_1:-/docker_unused_placeholder_1:/docker_unused_placeholder_1}
      - ${CUSTOM_DRIVE_MOUNT_2:-/docker_unused_placeholder_2:/docker_unused_placeholder_2}
      # Uncomment and add more mounts as needed:
      # - ${CUSTOM_DRIVE_MOUNT_3:-/docker_unused_placeholder_3:/docker_unused_placeholder_3}
      # - ${CUSTOM_DRIVE_MOUNT_4:-/docker_unused_placeholder_4:/docker_unused_placeholder_4}
      # - ${CUSTOM_DRIVE_MOUNT_5:-/docker_unused_placeholder_5:/docker_unused_placeholder_5}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s
    networks:
      - tma-cloud-network

  # Audit Worker - Required for processing audit events
  # Without this worker, audit events are queued but not written to the database
  worker:
    build:
      context: .
      dockerfile: Dockerfile
    image: tma-cloud:latest
    container_name: tma-cloud-worker
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - LOG_FORMAT=json
    volumes:
      # Mount same volumes as app service for consistency
      - ./uploads:/app/uploads
      # Custom drive mounts: Set CUSTOM_DRIVE_MOUNT_1, CUSTOM_DRIVE_MOUNT_2, etc. in .env
      # Format: CUSTOM_DRIVE_MOUNT_N=/host/path:/container/path (REQUIRED - must include colon)
      # Add more mount lines below if you need additional mounts (uncomment and add CUSTOM_DRIVE_MOUNT_3, etc.)
      # Leave empty if not using that mount slot (will use placeholder that won't consume storage)
      # Backend will reject placeholder paths if users try to use them
      - ${CUSTOM_DRIVE_MOUNT_1:-/docker_unused_placeholder_1:/docker_unused_placeholder_1}
      - ${CUSTOM_DRIVE_MOUNT_2:-/docker_unused_placeholder_2:/docker_unused_placeholder_2}
      # Uncomment and add more mounts as needed:
      # - ${CUSTOM_DRIVE_MOUNT_3:-/docker_unused_placeholder_3:/docker_unused_placeholder_3}
      # - ${CUSTOM_DRIVE_MOUNT_4:-/docker_unused_placeholder_4:/docker_unused_placeholder_4}
      # - ${CUSTOM_DRIVE_MOUNT_5:-/docker_unused_placeholder_5:/docker_unused_placeholder_5}
    command: node backend/audit-worker.js
    depends_on:
      - app
    networks:
      - tma-cloud-network

networks:
  tma-cloud-network:
    driver: bridge
